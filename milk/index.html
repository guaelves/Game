<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 ç‰›å¥¶å…Œæ›è¿½è¹¤å™¨</title>
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIk1pbGsgVHJhY2tlciIsCiAgInNob3J0X25hbWUiIjogIk1pbGsiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2Y4ZjlmYSIsCiAgInRoZW1lX2NvbG9yIjogIiM0YThmZmYiCn0=">
    <style>
        :root { --primary: #4a8fff; --bg: #f8f9fa; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 15px; display: flex; justify-content: center; margin: 0; }
        .app-container { max-width: 600px; width: 100%; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; margin-top: 0; cursor: pointer; user-select: none; }
        .stats { background: #e3f2fd; padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 15px; font-weight: bold; color: #1976d2; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .btn { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 14px; text-align: center; }
        .btn-setup { background: var(--primary); color: white; grid-column: span 2; }
        .btn-export { background: #eee; color: #444; }
        .btn-import { background: #eee; color: #444; }
        .btn:active { transform: scale(0.95); opacity: 0.8; }
        .table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; min-width: 400px; }
        th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #fafafa; color: #666; font-size: 0.85em; }
        .checkbox-cell { text-align: center; }
        input[type="checkbox"] { width: 32px; height: 32px; cursor: pointer; }
        .note-input { width: 90%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .completed { background-color: #f1f8e9 !important; color: #888; }
        .current-week { border-left: 5px solid var(--primary); background-color: #fffde7; font-weight: bold; }
        #fileInput { display: none; }
    </style>
</head>
<body>

<div class="app-container">
    <h2 id="appTitle">ğŸ¥› ç‰›å¥¶å…Œæ›è¿½è¹¤ ğŸ¥›</h2>
    <div id="statBox" class="stats">è¼‰å…¥ä¸­...</div>
    
    <div class="btn-group">
        <button class="btn btn-setup" onclick="setupNotifications()">ğŸ”” å•Ÿå‹•æ™ºèƒ½æé†’åŠŸèƒ½</button>
        <button class="btn btn-export" onclick="exportData()">ğŸ“¤ åŒ¯å‡ºå‚™ä»½</button>
        <button class="btn btn-import" onclick="document.getElementById('fileInput').click()">ğŸ“¥ åŒ¯å…¥å‚™ä»½</button>
        <input type="file" id="fileInput" accept=".json" onchange="importData(event)">
    </div>
    
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th style="width: 10%;">#</th>
                    <th style="width: 40%;">é ˜å–å€é–“</th>
                    <th style="width: 35%;">å‚™è¨»</th>
                    <th class="checkbox-cell">ç‹€æ…‹</th>
                </tr>
            </thead>
            <tbody id="calendarBody"></tbody>
        </table>
    </div>
</div>

<script>
    // è¨ºæ–·åŠŸèƒ½ï¼šé€£é»æ¨™é¡Œ 5 ä¸‹æ¸¬è©¦é€šçŸ¥æ¬Šé™
    let diagCount = 0;
    document.getElementById('appTitle').onclick = () => {
        diagCount++;
        if (diagCount >= 5) {
            if (Notification.permission === 'granted') {
                new Notification('âš™ï¸ ç³»çµ±è¨ºæ–·', { body: 'é€šçŸ¥æ¬Šé™æ­£å¸¸ï¼è‹¥èƒŒæ™¯æ”¶ä¸åˆ°ï¼Œè«‹æª¢æŸ¥æ‰‹æ©Ÿé›»æ± å„ªåŒ–è¨­å®šã€‚' });
            } else {
                alert('æ¬Šé™å°šæœªé–‹å•Ÿï¼è«‹æŒ‰è—è‰²æŒ‰éˆ•ã€‚');
            }
            diagCount = 0;
        }
    };

    function initCalendar() {
        const startDate = new Date('2026-02-23');
        const endDate = new Date('2026-06-30');
        let current = new Date(startDate);
        let bottleCount = 1;
        let completedCount = 0;
        let totalWeeks = 0;

        const tableBody = document.getElementById('calendarBody');
        tableBody.innerHTML = '';
        while (current <= endDate) {
            const mon = new Date(current);
            const sun = new Date(current);
            sun.setDate(mon.getDate() + 6);
            const sunTime = new Date(sun);
            sunTime.setHours(23,59,59,999);

            const weekId = `week-${mon.getFullYear()}-${mon.getMonth()+1}-${mon.getDate()}`;
            const isChecked = localStorage.getItem(weekId) === 'true';
            const savedNote = localStorage.getItem(weekId + '-note') || '';
            const isThisWeek = (new Date() >= mon && new Date() <= sunTime);

            if (isChecked) completedCount++;
            totalWeeks++;

            const row = document.createElement('tr');
            row.id = `row-${weekId}`;
            if (isChecked) row.className = 'completed';
            if (isThisWeek) row.classList.add('current-week');

            row.innerHTML = `
                <td>${bottleCount}</td>
                <td>${mon.getMonth() + 1}/${mon.getDate()} ~ ${sun.getMonth() + 1}/${sun.getDate()}</td>
                <td>
                    <input type="text" class="note-input" placeholder="..." 
                           id="${weekId}-note" value="${savedNote}" 
                           oninput="localStorage.setItem('${weekId}-note', this.value)">
                </td>
                <td class="checkbox-cell">
                    <input type="checkbox" id="${weekId}" ${isChecked ? 'checked' : ''} 
                           onchange="handleCheck('${weekId}', '${mon.toISOString()}', '${sunTime.toISOString()}')">
                </td>
            `;
            tableBody.appendChild(row);
            current.setDate(current.getDate() + 7);
            bottleCount++;
        }
        document.getElementById('statBox').innerText = `é€²åº¦ï¼šå·²é ˜ ${completedCount} / å‰©é¤˜ ${totalWeeks - completedCount} ç“¶`;
    }

    function handleCheck(id, monISO, sunISO) {
        const cb = document.getElementById(id);
        const now = new Date();
        if (cb.checked && (now < new Date(monISO) || now > new Date(sunISO))) {
            alert('âš ï¸ é ˜å–å¤±æ•—ï¼šä»Šå¤©ä¸åœ¨å…Œæ›æœŸé–“å…§ï¼');
            cb.checked = false; return;
        }
        localStorage.setItem(id, cb.checked);
        if (cb.checked) {
            const noteVal = document.getElementById(id + '-note');
            if (!noteVal.value) {
                const dateStr = `${now.getMonth() + 1}/${now.getDate()} é ˜å–`;
                noteVal.value = dateStr;
                localStorage.setItem(id + '-note', dateStr);
            }
        }
        initCalendar();
    }

    function runAutoReminders() {
        if (Notification.permission !== 'granted') return;
        const now = new Date();
        const day = now.getDay();
        const hour = now.getHours();
        
        const offset = (day === 0) ? -6 : 1 - day;
        const mon = new Date(now);
        mon.setDate(now.getDate() + offset);
        const weekId = `week-${mon.getFullYear()}-${mon.getMonth()+1}-${mon.getDate()}`;
        
        if (localStorage.getItem(weekId) === 'true') return;

        const tag = `milk-2026-${weekId}-${day}-${hour}`;
        const msgs = [
            "ğŸ”¥ æœ€å¾Œæœ€å¾Œï¼æœ¬é€±ç‰›å¥¶è¦æ°æ°å•¦ï¼",
            "ğŸ¥› æ–°çš„ä¸€é€±é–‹å§‹ï¼åˆ¥å¿˜äº†å…Œæ›æœ¬é€±ç‰›å¥¶ã€‚",
            "ğŸ§ª åˆæ˜¯ç¾å¥½çš„ä¸€å¤©ï¼Œé †è·¯å»æ›ç“¶ç‰›å¥¶å§ï¼",
            "â³ å°é€±æœ«ï¼Œç‰›å¥¶é ˜å–äº†å—ï¼Ÿ",
            "ğŸ“… ç‰›å¥¶æ™‚é–“ï¼Œè¨˜å¾—å»é ˜ç‰›å¥¶å–”ï¼",
            "âš ï¸ å€’æ•¸å…©å¤©ï¼å†ä¸é ˜å°±æ²’æ©Ÿæœƒäº†ï¼",
            "ğŸš¨ æ˜å¤©æœ€å¾Œä¸€å¤©ï¼è«‹å‹™å¿…å‰å¾€å…Œæ›ã€‚"
        ];
        
        // å¼·åŒ–ï¼šç™¼é€é€šçŸ¥çµ¦ Service Worker åŸ·è¡Œï¼Œå¢åŠ å­˜æ´»ç‡
        if (navigator.serviceWorker.controller) {
            navigator.serviceWorker.ready.then(reg => {
                reg.showNotification('ç‰›å¥¶å…Œæ›æé†’', { 
                    body: msgs[day], 
                    tag: tag, 
                    requireInteraction: true,
                    icon: 'https://cdn-icons-png.flaticon.com/512/372/372922.png'
                });
            });
        }
    }

    async function setupNotifications() {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            alert('é€šçŸ¥å·²å•Ÿå‹•ï¼è«‹å°‡æ­¤ App ã€Œæ›åœ¨èƒŒæ™¯ã€ä¸¦åœ¨æ‰‹æ©Ÿè¨­å®šä¸­é—œé–‰ã€Œé›»æ± æœ€ä½³åŒ–ã€ã€‚');
            runAutoReminders();
        }
    }

    function exportData() {
        const blob = new Blob([JSON.stringify(localStorage)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `ç‰›å¥¶å‚™ä»½.json`;
        a.click();
    }

    function importData(e) {
        const reader = new FileReader();
        reader.onload = (event) => {
            const data = JSON.parse(event.target.result);
            Object.keys(data).forEach(k => localStorage.setItem(k, data[k]));
            location.reload();
        };
        reader.readAsText(e.target.files[0]);
    }

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js');
    }

    initCalendar();
    runAutoReminders();
    // æ¯ 20 åˆ†é˜æª¢æŸ¥ä¸€æ¬¡ï¼Œå¢åŠ èƒŒæ™¯æƒæåˆ°æ•´é»çš„æ©Ÿç‡
    setInterval(runAutoReminders, 1200000); 
</script>
</body>
</html>