<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026å¹´2~7æœˆ ç‰›å¥¶å…Œæ›è¿½è¹¤</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIk1pbGsgVHJhY2tlciIsCiAgInNob3J0X25hbWUiIjogIk1pbGsiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2Y4ZjlmYSIsCiAgInRoZW1lX2NvbG9yIjogIiM0YThmZmYiCn0=">
    <style>
        :root { --primary: #4a8fff; --bg: #f8f9fa; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 15px; display: flex; justify-content: center; }
        .app-container { max-width: 650px; width: 100%; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        .btn-setup { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #fafafa; color: #666; font-size: 0.9em; }
        .checkbox-cell { text-align: center; }
        input[type="checkbox"] { width: 32px; height: 32px; cursor: pointer; vertical-align: middle; }
        .note-input { width: 90%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .completed { background-color: #f1f8e9; color: #888; }
        .completed .note-input { background-color: #f1f8e9; border-color: transparent; }
        .current-week { border-left: 5px solid var(--primary); background-color: #e3f2fd; font-weight: bold; }
    </style>
</head>
<body>

<div class="app-container">
    <h2>ğŸ¥› ç‰›å¥¶å…Œæ›è¿½è¹¤ ğŸ¥›</h2>
    <button class="btn-setup" onclick="setupNotifications()">ğŸ”” å•Ÿå‹•æ™ºèƒ½æé†’åŠŸèƒ½</button>
    
    <table>
        <thead>
            <tr>
                <th style="width: 15%;">ç·¨è™Ÿ</th>
                <th style="width: 35%;">æœŸé–“ (ä¸€~æ—¥)</th>
                <th style="width: 35%;">é ˜å–æ—¥</th>
                <th class="checkbox-cell">å®Œæˆ</th>
            </tr>
        </thead>
        <tbody id="calendarBody"></tbody>
    </table>
</div>

<script>
    const tableBody = document.getElementById('calendarBody');

    // 1. åˆå§‹åŒ–åˆ—è¡¨ (2/23 é–‹å§‹)
    function initCalendar() {
        const startDate = new Date('2026-02-23');
        const endDate = new Date('2026-06-30');
        let current = new Date(startDate);
        let bottleCount = 1;

        while (current <= endDate) {
            const mon = new Date(current);
            const sun = new Date(current);
            sun.setDate(mon.getDate() + 6);
            const sunTime = new Date(sun);
            sunTime.setHours(23,59,59,999);

            const weekId = `week-${mon.getFullYear()}-${mon.getMonth()+1}-${mon.getDate()}`;
            const isChecked = localStorage.getItem(weekId) === 'true';
            const savedNote = localStorage.getItem(weekId + '-note') || '';
            const isThisWeek = (new Date() >= mon && new Date() <= sunTime);

            const row = document.createElement('tr');
            row.id = `row-${weekId}`;
            if (isChecked) row.className = 'completed';
            if (isThisWeek) row.classList.add('current-week');

            row.innerHTML = `
                <td> ${bottleCount} </td>
                <td>${mon.getMonth() + 1}/${mon.getDate()} ~ ${sun.getMonth() + 1}/${sun.getDate()}</td>
                <td>
                    <input type="text" class="note-input" placeholder="å‹¾é¸è‡ªå‹•å¡«å…¥" 
                           id="${weekId}-note" value="${savedNote}" 
                           oninput="saveNote('${weekId}')">
                </td>
                <td class="checkbox-cell">
                    <input type="checkbox" id="${weekId}" ${isChecked ? 'checked' : ''} 
                           onchange="handleCheck('${weekId}', '${mon.toISOString()}', '${sunTime.toISOString()}')">
                </td>
            `;
            tableBody.appendChild(row);
            current.setDate(current.getDate() + 7);
            bottleCount++;
        }
    }

    // 2. å‹¾é¸é‚è¼¯ï¼šé˜²èª¤è§¸ + è‡ªå‹•æ—¥æœŸ
    function handleCheck(id, monISO, sunISO) {
        const cb = document.getElementById(id);
        const noteInput = document.getElementById(id + '-note');
        const row = document.getElementById('row-' + id);
        const now = new Date();

        if (cb.checked) {
            if (now < new Date(monISO) || now > new Date(sunISO)) {
                alert('âš ï¸ é ˜å–å¤±æ•—ï¼šä»Šå¤©ä¸åœ¨é€™ç“¶ç‰›å¥¶çš„å…Œæ›æœŸé–“å…§ï¼');
                cb.checked = false;
                return;
            }
            const dateStr = `${now.getMonth() + 1}/${now.getDate()} é ˜å–`;
            if (noteInput.value.trim() === "") {
                noteInput.value = dateStr;
                localStorage.setItem(id + '-note', dateStr);
            }
            row.classList.add('completed');
        } else {
            row.classList.remove('completed');
        }
        localStorage.setItem(id, cb.checked);
    }

    function saveNote(id) {
        localStorage.setItem(id + '-note', document.getElementById(id + '-note').value);
    }

    // 3. æ™ºèƒ½æé†’é‚è¼¯ (é€±ä¸€ã€ä¸‰ã€äº”ã€å…­)
    function runAutoReminders() {
        if (Notification.permission !== 'granted') return;

        const now = new Date();
        const day = now.getDay(); // 0æ—¥, 1ä¸€...
        const hour = now.getHours();

        // å–å¾—æœ¬é€±ä¸€ ID
        const offset = (day === 0) ? -6 : 1 - day;
        const mon = new Date(now);
        mon.setDate(now.getDate() + offset);
        const weekId = `week-${mon.getFullYear()}-${mon.getMonth()+1}-${mon.getDate()}`;
        
        const isChecked = localStorage.getItem(weekId) === 'true';
        if (isChecked) return; // æ›éäº†å°±ä¸åµä½ 

        let msg = "";
        const tag = `milk-${weekId}-${day}`; // ç¢ºä¿åŒæ—¥ä¸é‡è¤‡è·³å‡º

        if (day === 1 && hour >= 8 && hour < 10) msg = "ğŸ¥› æ–°çš„ä¸€é€±ï¼åˆ¥å¿˜äº†å…Œæ›æœ¬é€±ç‰›å¥¶ã€‚";
        else if (day === 3 && hour >= 8 && hour < 10) msg = "â³ å·²ç¶“éä¸‰å¤©å›‰ï¼Œæœ¬é€±ç‰›å¥¶å…Œæ›äº†å—ï¼Ÿ";
        else if (day === 5 && hour >= 8 && hour < 10) msg = "âš ï¸ å‰©å…©å¤©ï¼å¿«çµæŸäº†é‚„æ²’æ›å–”ï¼";
        else if (day === 6 && hour >= 20) msg = "ğŸš¨ æ˜å¤©æ˜¯æœ€å¾Œä¸€å¤©ï¼è«‹å‹™å¿…å‰å¾€å…Œæ›ã€‚";

        if (msg) {
            new Notification('ç‰›å¥¶å…Œæ›æé†’', {
                body: msg,
                icon: 'https://cdn-icons-png.flaticon.com/512/372/372922.png',
                tag: tag
            });
        }
    }

    async function setupNotifications() {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            alert('æé†’åŠŸèƒ½å•Ÿå‹•æˆåŠŸï¼');
            runAutoReminders();
        }
    }

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }

    initCalendar();
    // é€²å…¥ç¶²é ç«‹å³æª¢æŸ¥ï¼Œä¸¦æ¯å°æ™‚æª¢æŸ¥ä¸€æ¬¡
    runAutoReminders();
    setInterval(runAutoReminders, 3600000);
</script>
</body>
</html>