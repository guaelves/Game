<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç‰›å¥¶å…Œæ›è¨˜éŒ„</title>
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIk1pbGsgVHJhY2tlciIsCiAgInNob3J0X25hbWUiIjogIk1pbGsiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2Y4ZjlmYSIsCiAgInRoZW1lX2NvbG9yIjogIiM0YThmZmYiCn0=">
    <style>
        :root { --primary: #4a8fff; --bg: #f8f9fa; }
        * { box-sizing: border-box; } /* ç¢ºä¿ padding ä¸æœƒæ’é–‹å¯¬åº¦ */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); padding: 10px; display: flex; justify-content: center; margin: 0; }
        
        .app-container { width: 100%; max-width: 500px; background: white; padding: 15px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        h2 { text-align: center; color: #333; margin: 0 0 15px 0; font-size: 1.4em; }
        
        .stats-container { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
        .stats { background: #e3f2fd; padding: 8px; border-radius: 8px; text-align: center; font-weight: bold; color: #1976d2; font-size: 0.75em; line-height: 1.4; }
        
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .btn { padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 13px; text-align: center; }
        .btn-export { background: #eee; color: #444; }
        .btn-import { background: #eee; color: #444; }
        
        .phase-header { 
            background: #666; color: white; padding: 10px 12px; 
            border-radius: 6px; margin-top: 10px; font-size: 0.85em; 
            font-weight: bold; cursor: pointer; display: flex; 
            justify-content: space-between; align-items: center;
        }
        .phase-header::after { content: 'â–¼'; font-size: 0.7em; }
        .phase-header.collapsed::after { content: 'â–²'; }

        .table-wrapper { width: 100%; overflow: hidden; border-radius: 8px; border: 1px solid #eee; margin-top: 2px; }
        .collapsed-content { display: none; }
        
        table { width: 100%; border-collapse: collapse; table-layout: fixed; } /* å›ºå®šä½ˆå±€é˜²æ­¢æ’é–‹ */
        th, td { padding: 8px 4px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.85em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        th { background: #fafafa; color: #777; font-size: 0.75em; }
        
        /* æ¬„ä½å¯¬åº¦æ¯”ä¾‹åˆ†é… */
        .col-id { width: 10%; text-align: center; }
        .col-range { width: 42%; }
        .col-note { width: 28%; }
        .col-check { width: 20%; text-align: center; }

        .checkbox-cell { text-align: center; }
        input[type="checkbox"] { width: 28px; height: 28px; vertical-align: middle; cursor: pointer; margin: 0; }
        .note-input { width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; }
        
        .completed { background-color: #f1f8e9 !important; color: #999; }
        .current-week { border-left: 4px solid var(--primary); background-color: #fffde7; font-weight: bold; }
        #fileInput { display: none; }
    </style>
</head>
<body>

<div class="app-container">
    <h2>ğŸ¥› ç‰›å¥¶å…Œæ›è¨˜éŒ„ ğŸ¥›</h2>
    <div class="stats-container">
        <div id="stat1" class="stats">ç¬¬ä¸€éšæ®µï¼š-</div>
        <div id="stat2" class="stats">ç¬¬äºŒéšæ®µï¼š-</div>
    </div>
    
    <div class="btn-group">
        <button class="btn btn-export" onclick="exportData()">ğŸ“¤ åŒ¯å‡º</button>
        <button class="btn btn-import" onclick="document.getElementById('fileInput').click()">ğŸ“¥ åŒ¯å…¥</button>
        <input type="file" id="fileInput" accept=".json" onchange="importData(event)">
    </div>

    <div id="calendarContent"></div>
</div>

<script>
    const calendarContent = document.getElementById('calendarContent');
    const phases = [
        { id: 1, name: "ç¬¬ä¸€éšæ®µ (2026/2/23 ~ 2026/7/5)", start: "2026-02-23", end: "2026-07-05" },
        { id: 2, name: "ç¬¬äºŒéšæ®µ (2026/8/31 ~ 2027/1/24)", start: "2026-08-31", end: "2027-01-24" }
    ];

    function initCalendar() {
        calendarContent.innerHTML = '';
        const now = new Date();
        let overallBottleCount = 1;

        phases.forEach((phase) => {
            let phaseCompleted = 0;
            let phaseTotal = 0;
            const weekData = [];

            let current = new Date(phase.start);
            const phaseEnd = new Date(phase.end);

            while (current <= phaseEnd) {
                const mon = new Date(current);
                const sun = new Date(current);
                sun.setDate(mon.getDate() + 6);
                const sunTime = new Date(sun);
                sunTime.setHours(23,59,59,999);

                const weekId = `week-${mon.getFullYear()}-${mon.getMonth()+1}-${mon.getDate()}`;
                const isChecked = localStorage.getItem(weekId) === 'true';
                const savedNote = localStorage.getItem(weekId + '-note') || '';
                const isThisWeek = (now >= mon && now <= sunTime);

                if (isChecked) phaseCompleted++;
                phaseTotal++;

                weekData.push({
                    id: weekId,
                    num: overallBottleCount++,
                    range: `${mon.getMonth()+1}/${mon.getDate()} ~ ${sun.getMonth()+1}/${sun.getDate()}`,
                    note: savedNote,
                    checked: isChecked,
                    current: isThisWeek,
                    monISO: mon.toISOString(),
                    sunISO: sunTime.toISOString()
                });
                current.setDate(current.getDate() + 7);
            }

            document.getElementById(`stat${phase.id}`).innerHTML = `ç¬¬${['ä¸€','äºŒ'][phase.id-1]}éšæ®µ<br>å·²é ˜ ${phaseCompleted}/${phaseTotal}`;

            const phaseWrapper = document.createElement('div');
            const isFinished = (phaseCompleted === phaseTotal);
            const isCollapsed = localStorage.getItem(`collapse-phase-${phase.id}`) === 'true' || (phase.id === 2 && phaseCompleted === 0);
            
            const header = document.createElement('div');
            header.className = `phase-header ${isCollapsed ? 'collapsed' : ''}`;
            header.innerHTML = `<span>${phase.name} ${isFinished ? 'âœ…' : ''}</span>`;
            header.onclick = () => togglePhase(phase.id);

            const tableWrapper = document.createElement('div');
            tableWrapper.className = `table-wrapper ${isCollapsed ? 'collapsed-content' : ''}`;
            tableWrapper.id = `table-phase-${phase.id}`;

            let rowsHtml = weekData.map(w => `
                <tr class="${w.checked ? 'completed' : ''} ${w.current ? 'current-week' : ''}">
                    <td class="col-id">${w.num}</td>
                    <td class="col-range">${w.range}</td>
                    <td class="col-note"><input type="text" class="note-input" value="${w.note}" oninput="saveNote('${w.id}', this.value)"></td>
                    <td class="col-check checkbox-cell">
                        <input type="checkbox" ${w.checked ? 'checked' : ''} onchange="handleCheck('${w.id}', '${w.monISO}', '${w.sunISO}')">
                    </td>
                </tr>
            `).join('');

            tableWrapper.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th class="col-id">#</th>
                            <th class="col-range">é ˜å–æœŸé–“</th>
                            <th class="col-note">å‚™è¨»</th>
                            <th class="col-check">é ˜å–å‹¾é¸</th>
                        </tr>
                    </thead>
                    <tbody>${rowsHtml}</tbody>
                </table>
            `;

            phaseWrapper.appendChild(header);
            phaseWrapper.appendChild(tableWrapper);
            calendarContent.appendChild(phaseWrapper);
        });
    }

    function togglePhase(id) {
        const table = document.getElementById(`table-phase-${id}`);
        const header = table.previousElementSibling;
        const isNowCollapsed = table.classList.toggle('collapsed-content');
        header.classList.toggle('collapsed');
        localStorage.setItem(`collapse-phase-${id}`, isNowCollapsed);
    }

    function handleCheck(id, monISO, sunISO) {
        const now = new Date();
        const isChecked = event.target.checked;
        if (isChecked && (now < new Date(monISO) || now > new Date(sunISO))) {
            alert('âš ï¸ ä¸åœ¨è©²æœŸé–“å…§ï¼');
            event.target.checked = false;
            return;
        }
        localStorage.setItem(id, isChecked);
        if (isChecked && !localStorage.getItem(id + '-note')) {
            localStorage.setItem(id + '-note', `${now.getMonth()+1}/${now.getDate()} é ˜å–`);
        }
        initCalendar();
    }

    function saveNote(id, val) {
        localStorage.setItem(id + '-note', val);
    }

    function exportData() {
        const blob = new Blob([JSON.stringify(localStorage)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `ç‰›å¥¶å‚™ä»½.json`;
        a.click();
    }

    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                Object.keys(data).forEach(k => localStorage.setItem(k, data[k]));
                location.reload();
            } catch (err) { alert('åŒ¯å…¥éŒ¯èª¤'); }
        };
        reader.readAsText(file);
    }

    initCalendar();
</script>
</body>
</html>

