<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ…¢æ—…æ—¥è¨˜ | AI å°å…¥ç‰ˆ</title>
    <style>
        :root { --primary: #2c3e50; --bg: #f8f9fa; --card: #ffffff; }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin: 0; color: #333; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 500px; margin: 0 auto; background: var(--card); min-height: 100vh; position: relative; box-shadow: 0 0 15px rgba(0,0,0,0.05); }
        header { padding: 20px 20px 10px; border-bottom: 1px solid #eee; position: sticky; top: 0; background: #fff; z-index: 100; }
        .nav-tabs { display: flex; overflow-x: auto; gap: 15px; margin-top: 15px; border-bottom: 1px solid #f0f0f0; }
        .tab { white-space: nowrap; color: #999; cursor: pointer; font-size: 14px; font-weight: bold; padding: 10px 5px; border-bottom: 3px solid transparent; }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .content { padding: 15px; padding-bottom: 80px; }
        .card { border: 1px solid #eee; border-radius: 12px; padding: 15px; margin-bottom: 15px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        input, textarea { width: 100%; border: 1px solid #eee; padding: 10px; box-sizing: border-box; border-radius: 8px; font-size: 14px; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        th, td { border: 1px solid #f0f0f0; padding: 8px; text-align: center; }
        .day-nav { display: flex; gap: 8px; overflow-x: auto; margin-bottom: 15px; padding: 5px 0; }
        .day-btn { min-width: 42px; height: 42px; border-radius: 50%; border: 1px solid #ddd; background: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 13px; font-weight: bold; }
        .day-btn.active { background: var(--primary); color: white; border: none; }
        /* åœ–ç‰‡æ–¹æ¡†æ¨£å¼ */
        .upload-box { border: 2px dashed #ccd0d5; border-radius: 10px; padding: 20px; text-align: center; color: #999; cursor: pointer; margin: 10px 0; transition: 0.3s; }
        .upload-box:hover { background: #f0f2f5; border-color: var(--primary); }
        .preview-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
        .thumb-wrap { position: relative; width: 100%; aspect-ratio: 1; }
        .thumb { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; border: 1px solid #eee; }
        .del-img { position: absolute; top: -5px; right: -5px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 12px; border: none; cursor: pointer; }
        .btn { border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-save { background: #27ae60; color: white; }
        .btn-add { background: var(--primary); color: white; width: 100%; padding: 15px; margin-top: 10px; }
        .hidden { display: none; }
        .pack-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #f9f9f9; }
        .pack-item input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary); }
    </style>
</head>
<body>

<div class="container" id="app">
    <div id="view-list">
        <header><h1>æ…¢æ—…æ—¥è¨˜</h1><p style="color:#999; font-size:11px;">AI å°å…¥ç‰ˆ</p></header>
        <div class="content" id="trip-list-container"></div>
        <div style="padding:20px;"><button class="btn btn-add" onclick="createNewTrip()">+ å»ºç«‹æ–°è¡Œç¨‹</button></div>
    </div>

    <div id="view-detail" class="hidden">
        <header>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button onclick="showList()" style="border:none; background:none; font-size:20px; color:#999;">â®</button>
                <button class="btn btn-save" onclick="saveAll()">ğŸ’¾ å­˜æª”</button>
            </div>
            <div class="nav-tabs">
                <div class="tab active" onclick="switchTab('info', this)">âœˆï¸ æ¦‚è¦½</div>
                <div class="tab" onclick="switchTab('plan', this)">ğŸ“ è¡Œç¨‹</div>
                <div class="tab" onclick="switchTab('vault', this)">ğŸ“‚ æ–‡ä»¶</div>
                <div class="tab" onclick="switchTab('pack', this)">ğŸ’ è¡Œæ</div>
            </div>
        </header>

        <div class="content">
            <div id="tab-info">
                <div class="card"><label style="font-size:12px; color:#999;">è¡Œç¨‹æ¨™é¡Œ</label><input type="text" id="info-title"></div>
                <div class="card">
                    <label style="font-size:12px; color:#999;">âœˆï¸ èˆªç­/äº¤é€š</label>
                    <table>
                        <tr style="background:#f9f9f9;"><th>è¡Œç¨‹</th><th>æ—¥æœŸ</th><th>æ™‚é–“</th><th>å‚™è¨»/èˆªç­</th></tr>
                        <tr><td>å»ç¨‹</td><td><input type="text" id="f-go-d"></td><td><input type="text" id="f-go-t"></td><td><input type="text" id="f-go-n"></td></tr>
                        <tr><td>å›ç¨‹</td><td><input type="text" id="f-bk-d"></td><td><input type="text" id="f-bk-t"></td><td><input type="text" id="f-bk-n"></td></tr>
                    </table>
                </div>
                <div class="card"><label style="font-size:12px; color:#999;">ğŸ¨ ä½å®¿èˆ‡é£¯åº—å‚™è¨»</label><textarea id="info-hotel" rows="4"></textarea></div>
            </div>

            <div id="tab-plan" class="hidden">
                <div class="card" style="background:#2c3e50; color:white;">
                    <div style="font-size:12px; margin-bottom:8px;">âœ¨ å…¨è¡Œç¨‹ AI å°å…¥ (æ‹¬è™Ÿå…§å®¹è‡ªå‹•æ­¸å…¥å‚™è¨»)</div>
                    <textarea id="ai-input" rows="4" style="background:#3e4f5f; border:none; color:white;" placeholder="Day 1&#10;10:00 æ±äº¬è»Šç«™ (æ‹ç…§æ™¯é»)"></textarea>
                    <button class="btn" onclick="processAI()" style="width:100%; margin-top:10px; background:#27ae60; color:white;">è§£æä¸¦åŒæ­¥èˆªç­</button>
                </div>
                <div class="day-nav" id="day-nav"></div>
                <div id="plan-list"></div>
                <button class="btn" onclick="addAct()" style="width:100%; background:#f0f0f0; color:#666;">+ æ‰‹å‹•æ–°å¢é …ç›®</button>
            </div>

            <div id="tab-vault" class="hidden"><div id="vault-list"></div></div>

            <div id="tab-pack" class="hidden"><div id="pack-list"></div></div>
        </div>
    </div>
</div>

<script>
    let trips = JSON.parse(localStorage.getItem('travel_v8_local')) || {};
    let curId = null, curDay = 0;

    const defaultPackSetup = {
        "è¨¼ä»¶é¡/è²¨å¹£": ["è­·ç…§", "èº«ä»½è­‰", "æ—¥å¹£", "å°å¹£", "ä¿¡ç”¨å¡", "è»Šç¥¨", "è¥¿ç“œå¡"],
        "å€‹äººç”¨å“": ["ä¿é¤Šå“", "è­·å”‡è†", "æ—¥æ‹‹éš±çœ¼", "çœ¼é¡ç›’", "æ°´å£º", "èƒŒåŒ…", "æº¼ç´™å·¾", "é¢ç´™", "è‡ªæ‹æ£’", "è¡£ç‰©"],
        "3Cç”¨å“": ["æ‰‹æ©Ÿ", "è¡Œå‹•é›»æº", "è€³æ©Ÿ", "å……é›»ç·š", "æ’æ’"],
        "å…¶ä»–": ["é§•ç…§è­¯æœ¬æ–‡ä»¶", "é ç´„æ©Ÿå ´æ¥é€"]
    };
    const defaultVaultCats = ["æ©Ÿç¥¨æ–‡ä»¶", "é£¯åº—æ–‡ä»¶", "VJWç”³è«‹", "ä¿éšª", "å„æ™¯é»é–€ç¥¨"];

    function renderTripList() {
        const c = document.getElementById('trip-list-container'); c.innerHTML = '';
        for(let id in trips) {
            const d = document.createElement('div'); d.className = 'card'; d.style.display='flex'; d.style.justifyContent='space-between'; d.style.alignItems='center';
            d.innerHTML = `<div onclick="openTrip('${id}')" style="flex:1; cursor:pointer;"><strong>${trips[id].title}</strong><div style="font-size:11px; color:#999; margin-top:4px;">${trips[id].days.length} å¤©</div></div><button onclick="delTrip('${id}')" style="border:none; color:#ccc; background:none; font-size:18px;">âœ•</button>`;
            c.appendChild(d);
        }
    }

    function createNewTrip() {
        const id = 't'+Date.now();
        trips[id] = { title: 'æˆ‘çš„æ—¥æœ¬ä¹‹æ—…', hotel: '', flight: {go:{}, bk:{}}, days: [{acts:[]}], vault: {}, packs: {} };
        defaultVaultCats.forEach(v => trips[id].vault[v] = []);
        for(let cat in defaultPackSetup) trips[id].packs[cat] = defaultPackSetup[cat].map(item => ({t:item, d:false}));
        curId = id; showDetail();
    }

    function processAI() {
        const txt = document.getElementById('ai-input').value; if(!txt) return;
        const lines = txt.split('\n'); let newDays = [], dIdx = -1;
        lines.forEach(l => {
            const raw = l.trim(); if(!raw) return;
            if(raw.match(/(Day\s*\d+|ç¬¬\s*.*\s*å¤©|D\d+)/i)) { dIdx++; newDays[dIdx] = {acts:[]}; }
            else {
                if(dIdx === -1) { dIdx=0; newDays[dIdx]={acts:[]}; }
                let time = (raw.match(/^(\d{1,2}[:ï¼š]\d{2})/) || ["",""])[1];
                let content = raw.replace(time, '').trim();
                let note = (content.match(/\(([^)]+)\)/) || ["",""])[1];
                let loc = content.replace(/\([^)]+\)/, '').trim().replace(/^[-:ï¼š ]+/, '');
                newDays[dIdx].acts.push({ time, loc, note, imgs: [] });
                // èˆªç­åŒæ­¥
                if(loc.includes("æ©Ÿå ´")) {
                    if(dIdx === 0) { trips[curId].flight.go = { d: "Day 1", t: time, n: loc }; }
                    else if(dIdx >= newDays.length - 1) { trips[curId].flight.bk = { d: `Day ${dIdx+1}`, t: time, n: loc }; }
                }
            }
        });
        trips[curId].days = newDays; curDay = 0; renderPlan(); fillInfo(); alert('âœ¨ è¡Œç¨‹èˆ‡èˆªç­å·²åŒæ­¥ï¼');
    }

    function renderPlan() {
        const nav = document.getElementById('day-nav'); nav.innerHTML = '';
        trips[curId].days.forEach((_, i) => {
            const b = document.createElement('div'); b.className = `day-btn ${i===curDay?'active':''}`; b.innerText = `D${i+1}`;
            b.onclick = () => { curDay = i; renderPlan(); }; nav.appendChild(b);
        });
        const list = document.getElementById('plan-list'); list.innerHTML = '';
        trips[curId].days[curDay].acts.forEach((a, i) => {
            const d = document.createElement('div'); d.className = 'card';
            d.innerHTML = `
                <div style="display:flex; gap:8px"><input style="width:65px; font-weight:bold" value="${a.time}" placeholder="æ™‚é–“" onchange="trips[curId].days[curDay].acts[${i}].time=this.value">
                <input style="flex:1; font-weight:bold" value="${a.loc}" placeholder="æ™¯é»åœ°é»" onchange="trips[curId].days[curDay].acts[${i}].loc=this.value">
                <button onclick="trips[curId].days[curDay].acts.splice(${i},1);renderPlan()" style="border:none;background:none;color:#ddd">âœ•</button></div>
                <textarea placeholder="é»æ­¤è¼¸å…¥å‚™è¨»..." onchange="trips[curId].days[curDay].acts[${i}].note=this.value">${a.note || ''}</textarea>
                <div class="upload-box" onclick="document.getElementById('file-${i}').click()">ğŸ“· åŠ å…¥ç…§ç‰‡ (å¯å¤šé¸)</div>
                <input type="file" id="file-${i}" class="hidden" multiple accept="image/*" onchange="handleImgs(this, ${i})">
                <div class="preview-grid" id="pre-${i}"></div>
                <a style="font-size:11px; color:#2980b9; text-decoration:none; font-weight:bold; margin-top:10px; display:inline-block;" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(a.loc)}" target="_blank">ğŸ“ Google Map</a>`;
            list.appendChild(d);
            renderImgs(i);
        });
    }

    function handleImgs(input, actIdx) {
        Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => { trips[curId].days[curDay].acts[actIdx].imgs.push(e.target.result); renderImgs(actIdx); };
            reader.readAsDataURL(file);
        });
    }

    function renderImgs(actIdx) {
        const grid = document.getElementById(`pre-${actIdx}`); if(!grid) return;
        grid.innerHTML = '';
        trips[curId].days[curDay].acts[actIdx].imgs.forEach((src, imgIdx) => {
            const w = document.createElement('div'); w.className = 'thumb-wrap';
            w.innerHTML = `<img src="${src}" class="thumb" onclick="window.open().document.write('<img src=\\'${src}\\' style=\\'width:100%\\'>')"><button class="del-img" onclick="trips[curId].days[curDay].acts[${actIdx}].imgs.splice(${imgIdx},1);renderImgs(${actIdx})">âœ•</button>`;
            grid.appendChild(w);
        });
    }

    function renderPack() {
        const h = document.getElementById('pack-list'); h.innerHTML = '';
        for(let cat in trips[curId].packs) {
            const d = document.createElement('div'); d.className = 'card';
            d.innerHTML = `<div style="font-weight:bold; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">${cat}</div>`;
            trips[curId].packs[cat].forEach((p, i) => {
                const row = document.createElement('div'); row.className = 'pack-item';
                row.innerHTML = `<input type="checkbox" ${p.d?'checked':''} onchange="trips[curId].packs['${cat}'][${i}].d=this.checked"><input style="border:none; padding:2px" value="${p.t}" onchange="trips[curId].packs['${cat}'][${i}].t=this.value"><span onclick="trips[curId].packs['${cat}'].splice(${i},1);renderPack()" style="color:#ccc; margin-left:auto">âœ•</span>`;
                d.appendChild(row);
            });
            d.innerHTML += `<button onclick="trips[curId].packs['${cat}'].push({t:'',d:false});renderPack()" style="width:100%; border:1px dashed #ddd; background:none; padding:5px; margin-top:10px; border-radius:5px; color:#999; font-size:12px;">+ æ–°å¢é …ç›®</button>`;
            h.appendChild(d);
        }
    }

    function renderVault() {
        const h = document.getElementById('vault-list'); h.innerHTML = '';
        for(let cat in trips[curId].vault) {
            const d = document.createElement('div'); d.className = 'card';
            d.innerHTML = `<div style="font-weight:bold; margin-bottom:10px;">${cat}</div><div class="upload-box" onclick="document.getElementById('vault-file-${cat}').click()">ğŸ“ ä¸Šå‚³æ–‡ä»¶æˆªåœ–</div><input type="file" id="vault-file-${cat}" class="hidden" multiple onchange="handleVault('${cat}', this)"><div class="preview-grid" id="vault-pre-${cat}"></div>`;
            h.appendChild(d);
            const grid = document.getElementById(`vault-pre-${cat}`);
            trips[curId].vault[cat].forEach((src, imgIdx) => {
                const w = document.createElement('div'); w.className = 'thumb-wrap';
                w.innerHTML = `<img src="${src}" class="thumb" onclick="window.open().document.write('<img src=\\'${src}\\' style=\\'width:100%\\'>')"><button class="del-img" onclick="trips[curId].vault['${cat}'].splice(${imgIdx},1);renderVault()">âœ•</button>`;
                grid.appendChild(w);
            });
        }
    }

    function handleVault(cat, input) {
        Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => { trips[curId].vault[cat].push(e.target.result); renderVault(); };
            reader.readAsDataURL(file);
        });
    }

    function fillInfo() {
        const t = trips[curId]; document.getElementById('info-title').value = t.title; document.getElementById('info-hotel').value = t.hotel;
        document.getElementById('f-go-d').value = t.flight.go.d || ''; document.getElementById('f-go-t').value = t.flight.go.t || ''; document.getElementById('f-go-n').value = t.flight.go.n || '';
        document.getElementById('f-bk-d').value = t.flight.bk.d || ''; document.getElementById('f-bk-t').value = t.flight.bk.t || ''; document.getElementById('f-bk-n').value = t.flight.bk.n || '';
    }

    function saveAll() {
        const t = trips[curId]; t.title = document.getElementById('info-title').value; t.hotel = document.getElementById('info-hotel').value;
        t.flight.go = { d: document.getElementById('f-go-d').value, t: document.getElementById('f-go-t').value, n: document.getElementById('f-go-n').value };
        t.flight.bk = { d: document.getElementById('f-bk-d').value, t: document.getElementById('f-bk-t').value, n: document.getElementById('f-bk-n').value };
        localStorage.setItem('travel_v8_local', JSON.stringify(trips)); alert('âœ… å·²å­˜æª”è‡³æ‰‹æ©Ÿï¼');
    }

    function switchTab(id, el) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); el.classList.add('active');
        ['info', 'plan', 'vault', 'pack'].forEach(k => document.getElementById('tab-'+k).classList.add('hidden'));
        document.getElementById('tab-'+id).classList.remove('hidden');
        if(id==='pack') renderPack(); if(id==='vault') renderVault();
    }

    function openTrip(id) { curId = id; showDetail(); }
    function delTrip(id) { if(confirm('ç¢ºå®šè¦åˆªé™¤æ•´å€‹è¡Œç¨‹å—ï¼Ÿ')) { delete trips[id]; localStorage.setItem('travel_v8_local', JSON.stringify(trips)); renderTripList(); } }
    function showDetail() { document.getElementById('view-list').classList.add('hidden'); document.getElementById('view-detail').classList.remove('hidden'); fillInfo(); renderPlan(); }
    function showList() { document.getElementById('view-list').classList.remove('hidden'); document.getElementById('view-detail').classList.add('hidden'); renderTripList(); }
    function addAct() { trips[curId].days[curDay].acts.push({time:'', loc:'', note:'', imgs:[]}); renderPlan(); }

    renderTripList();
</script>
</body>
</html>